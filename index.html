<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Korean Priming Experiment 2026</title>
  <style>
    html, body { height: 100%; font-family: system-ui, sans-serif; margin: 0; background: #fff; display: flex; justify-content: center; align-items: flex-start; padding: 24px; box-sizing: border-box; }
    .card { width: min(760px, 100%); border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 0 0 24px 0; }
    .hidden { display: none !important; }
    #afcChoices { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
    #afcChoices button { width:100%; padding: 12px; font-size: 16px; }
    label { display:block; margin: 10px 0 6px; font-weight: bold; }
    input, select { width: 100%; padding: 8px; font-size: 16px; margin-bottom: 10px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; border-radius: 6px; border: 1px solid #ccc; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .note { font-size: 14px; color:#444; line-height: 1.6; }
    .study-instruction { font-size: 16px; color: #000; }
    
    /* 추가된 UI 요소 */
    #experimentHeader { width: 100%; margin-bottom: 20px; }
    .progress-container { width: 100%; background: #eee; border-radius: 5px; height: 10px; overflow: hidden; }
    #mainProgressBar { width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s; }
    .mic-gauge-container { width: 200px; height: 8px; background: #ddd; border-radius: 4px; margin: 10px auto; overflow: hidden; }
    #liveMicFill { width: 0%; height: 100%; background: #2196F3; }
  </style>
</head>

<body>

<div class="card" id="screen-consent">
  <h1 style="margin-top:0;">실험 참여</h1>
  <h2>연구 참여 동의</h2>
  <p class="note">
    본 실험은 그림 학습, 4지선다 테스트, 그리고 본 실험(그림 보고 말하기)으로 구성됩니다.<br>
    음성 녹음을 위해 마이크 세팅을 확인해주세요. 잦은 무응답 시 실험이 자동 종료될 수 있습니다.
  </p>
  <label><input type="checkbox" id="consentCheck"> 연구 참여에 동의합니다.</label>
  <hr>
  <h3>참가자 정보</h3>
  <label>닉네임 (실명X)</label><input id="nick" placeholder="예: HJ">
  <label>생년월</label><input id="birthYM" type="month">
  <label>성별</label>
  <select id="gender"><option value="">선택</option><option value="male">남</option><option value="female">여</option></select>
  <label>모국어</label><input id="nativeLang" value="한국어">
  <label>외국어(들)</label><input id="otherLangs" placeholder="없으면 '없음'">
  <button id="btnStart" disabled>동의하고 시작</button>
</div>

<div class="card hidden" id="screen-ready">
  <h2>준비 완료</h2>
  <p>이제부터 학습 단계를 시작합니다.</p>
  <button id="btnContinue">계속</button>
</div>

<div class="card hidden" id="screen-study">
  <h2>학습</h2>
  <p class="note study-instruction" id="studyProgress">
    그림과 단어를 잘 보고 기억해 주세요. 학습은 2회 반복됩니다.
  </p>
  <div style="height:380px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div id="fixation" class="hidden" style="font-size:48px;">+</div>
    <img id="studyImg" class="hidden" style="max-width:420px; max-height:320px;">
    <div id="studyLabel" class="hidden" style="font-size:28px; margin-top:10px;"></div>
  </div>
  <div style="margin-top:16px; text-align:center;">
    <button id="btnStartStudy">학습 시작</button>
    <button id="btnNextAfterStudy" class="hidden">다음 (4지선다 테스트)</button>
  </div>
</div>

<div class="card hidden" id="screen-afc">
  <h2>4지선다 테스트</h2>
  <div style="text-align:center;"><img id="afcImg" style="max-width:420px; max-height:320px;" /></div>
  <div id="afcChoices"></div>
  <p class="note" id="afcTimer" style="text-align:center;"></p>
  <button id="btnNextAFC" class="hidden">다음</button>
</div>

<div class="card hidden" id="screen-afc-result">
  <h2>확인 테스트 결과</h2>
  <p id="afcResultText"></p>
  <div id="afcResultButtons" style="margin-top:16px; text-align:center;">
    <button id="btnAfcRemedial" class="hidden">오답만 다시 학습하고 재시험</button>
    <button id="btnAfcProceed" class="hidden">다음 단계로 진행</button>
  </div>
</div>

<div class="card hidden" id="screen-mic">
  <h2>마이크 확인</h2>
  <p class="note" id="micText"></p>
  <progress id="micMeter" value="0" max="1" style="width:100%; height:18px;"></progress>
  <div style="margin-top:16px; text-align:center;">
    <button id="btnMicStart">마이크 권한 확인</button>
    <button id="btnMicNext" class="hidden">본 실험 시작</button>
  </div>
</div>

<div class="card hidden" id="screen-priming">
  <div id="experimentHeader">
    <div class="progress-container"><div id="mainProgressBar"></div></div>
    <p id="trialCounter" style="text-align:right; font-size:12px;">0 / 108</p>
  </div>
  <div style="height:400px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div id="primingFixation" class="hidden" style="font-size:48px;">+</div>
    <img id="primingImg" class="hidden" style="max-width:420px; max-height:320px;">
  </div>
  <div class="mic-monitor">
    <div class="mic-gauge-container"><div id="liveMicFill"></div></div>
  </div>
  <p id="primingStatus" style="text-align:center; font-weight:bold; font-size:22px; color:#d32f2f;"></p>
  <div id="animacyButtons" class="hidden" style="display:flex; gap:10px; justify-content:center;">
    <button id="btnAnimate">생물</button>
    <button id="btnInanimate">무생물</button>
  </div>
</div>

<div class="card hidden" id="screen-contact">
  <h2>실험 종료</h2>
  <label>보상용 휴대폰 번호</label>
  <input id="contactValue" placeholder="010-1234-5678">
  <button id="btnSubmitContact">제출하고 종료</button>
</div>

<script type="module">
import { jsonp, createSession, appendRow, uploadAudioBlob } from "./js/api.js";

/* State & Config */
let session = null;
let assignedGroup = null;
let STUDY_ITEMS = [];
let PRIMING_TRIALS = [];
let timeoutCount = 0;
let uploadFailCount = 0;
const FAIL_LIMIT = 10;
const TOTAL_TRIALS_NUM = 108; // 18개 * 6조건

/* UI Elements */
const screens = {
  consent: document.getElementById("screen-consent"),
  ready: document.getElementById("screen-ready"),
  study: document.getElementById("screen-study"),
  afc: document.getElementById("screen-afc"),
  afcResult: document.getElementById("screen-afc-result"),
  mic: document.getElementById("screen-mic"),
  priming: document.getElementById("screen-priming"),
  contact: document.getElementById("screen-contact")
};

/* Validation */
function validateForm() {
  const consent = document.getElementById("consentCheck").checked;
  const nick = document.getElementById("nick").value.trim();
  const birth = document.getElementById("birthYM").value;
  const gender = document.getElementById("gender").value;
  document.getElementById("btnStart").disabled = !(consent && nick && birth && gender);
}
["consentCheck", "nick", "birthYM", "gender"].forEach(id => {
  document.getElementById(id).addEventListener("input", validateForm);
  document.getElementById(id).addEventListener("change", validateForm);
});

/* CSV Loader */
async function loadCSV(path) {
  const res = await fetch(path);
  const text = await res.text();
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",").map(h => h.trim());
  return lines.slice(1).map(line => {
    const values = line.split(",").map(v => v.trim());
    return headers.reduce((obj, h, i) => ({ ...obj, [h]: values[i] }), {});
  });
}

/* Mic Monitoring */
function startMicMonitoring() {
  if (!window.analyser) return;
  const dataArray = new Uint8Array(window.analyser.fftSize);
  function update() {
    if (screens.priming.classList.contains("hidden")) return;
    window.analyser.getByteTimeDomainData(dataArray);
    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) {
      const v = (dataArray[i] - 128) / 128;
      sum += v * v;
    }
    const rms = Math.sqrt(sum / dataArray.length);
    document.getElementById("liveMicFill").style.width = Math.min(100, rms * 800) + "%";
    requestAnimationFrame(update);
  }
  update();
}

/* Recording (3s Fixed) */
async function recordThreeSeconds() {
  const chunks = [];
  const recorder = new MediaRecorder(window.micStream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.start();
  
  // Timeout 및 Onset 감지
  const onsetPromise = detectVoiceOnset(3000); 
  await new Promise(r => setTimeout(r, 3000)); // 무조건 3초 녹음
  
  recorder.stop();
  const onset = await onsetPromise;
  const blob = await new Promise(r => {
    recorder.onstop = () => r(new Blob(chunks, { type: "audio/webm" }));
  });
  return { onset, blob };
}

async function detectVoiceOnset(maxMs) {
  const start = performance.now();
  const dataArray = new Uint8Array(window.analyser.fftSize);
  const threshold = 0.02; // 기본 임계치
  return new Promise(resolve => {
    function check() {
      window.analyser.getByteTimeDomainData(dataArray);
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = (dataArray[i] - 128) / 128;
        sum += v * v;
      }
      if (Math.sqrt(sum / dataArray.length) > threshold) {
        resolve(Math.round(performance.now() - start));
      } else if (performance.now() - start > maxMs) {
        resolve(null); // Timeout 발생
      } else {
        requestAnimationFrame(check);
      }
    }
    check();
  });
}

/* 1. Start Session */
document.getElementById("btnStart").onclick = async () => {
  const listNum = Math.floor(Math.random() * 3) + 1;
  const [itemsData, pairsData] = await Promise.all([
    loadCSV("./stim/items.csv"),
    loadCSV(`./stim/pairs_list_${listNum}.csv`)
  ]);

  // STUDY_ITEMS 추출 (pairs에 사용된 모든 ID)
  const usedIds = new Set();
  pairsData.forEach(p => { usedIds.add(p.primeId); usedIds.add(p.targetId); });
  STUDY_ITEMS = itemsData.filter(i => usedIds.has(i.itemId)).map(i => ({...i, img: "./stim/"+i.img}));
  PRIMING_TRIALS = pairsData;

  const groups = ["overt", "covert", "nonaming"];
  assignedGroup = groups[Math.floor(Math.random() * groups.length)];

  const pid = document.getElementById("nick").value + "_" + Date.now();
  session = await createSession(pid, { primeModeGroup: assignedGroup });
  
  screens.consent.classList.add("hidden");
  screens.ready.classList.remove("hidden");
};

/* 2. Study Phase */
document.getElementById("btnContinue").onclick = () => {
  screens.ready.classList.add("hidden");
  screens.study.classList.remove("hidden");
};

document.getElementById("btnStartStudy").onclick = async () => {
  document.getElementById("btnStartStudy").classList.add("hidden");
  for (let pass = 1; pass <= 2; pass++) {
    const shuffled = [...STUDY_ITEMS].sort(() => Math.random() - 0.5);
    for (let i = 0; i < shuffled.length; i++) {
      document.getElementById("studyProgress").textContent = `학습 중: ${pass}/2 회차 - ${i+1}/${shuffled.length}`;
      document.getElementById("fixation").classList.remove("hidden");
      await new Promise(r => setTimeout(r, 200));
      document.getElementById("fixation").classList.add("hidden");
      
      document.getElementById("studyImg").src = shuffled[i].img;
      document.getElementById("studyImg").classList.remove("hidden");
      await new Promise(r => setTimeout(r, 500));
      
      document.getElementById("studyLabel").textContent = shuffled[i].word;
      document.getElementById("studyLabel").classList.remove("hidden");
      await new Promise(r => setTimeout(r, 500));
      
      document.getElementById("studyImg").classList.add("hidden");
      document.getElementById("studyLabel").classList.add("hidden");
    }
  }
  document.getElementById("studyProgress").textContent = "학습 완료!";
  document.getElementById("btnNextAfterStudy").classList.remove("hidden");
};

/* 3. Priming Phase (Main) */
// (4AFC 로직은 원본과 동일하게 유지하되 화면 전환만 본 실험으로 연결)
document.getElementById("btnNextAfterStudy").onclick = () => {
  screens.study.classList.add("hidden");
  screens.mic.classList.remove("hidden"); // 마이크 확인 후 본 실험 시작
};

document.getElementById("btnMicStart").onclick = async () => {
  window.micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  window.analyser = audioCtx.createAnalyser();
  audioCtx.createMediaStreamSource(window.micStream).connect(window.analyser);
  document.getElementById("btnMicStart").classList.add("hidden");
  document.getElementById("btnMicNext").classList.remove("hidden");
};

document.getElementById("btnMicNext").onclick = async () => {
  screens.mic.classList.add("hidden");
  screens.priming.classList.remove("hidden");
  startMicMonitoring();
  runPrimingExperiment();
};

async function runPrimingExperiment() {
  for (let i = 0; i < PRIMING_TRIALS.length; i++) {
    const trial = PRIMING_TRIALS[i];
    document.getElementById("mainProgressBar").style.width = ((i / TOTAL_TRIALS_NUM) * 100) + "%";
    document.getElementById("trialCounter").textContent = `${i + 1} / ${TOTAL_TRIALS_NUM}`;

    // Fixation
    document.getElementById("primingFixation").classList.remove("hidden");
    await new Promise(r => setTimeout(r, 300));
    document.getElementById("primingFixation").classList.add("hidden");

    // Prime
    const img = document.getElementById("primingImg");
    img.src = "./stim/" + trial.prime_pic;
    img.classList.remove("hidden");
    
    if (assignedGroup === "overt") {
      document.getElementById("primingStatus").textContent = "말하세요";
      await recordThreeSeconds();
    } else if (assignedGroup === "nonaming") {
      document.getElementById("primingStatus").textContent = "생물?";
      document.getElementById("animacyButtons").classList.remove("hidden");
      await new Promise(r => {
        document.getElementById("btnAnimate").onclick = r;
        document.getElementById("btnInanimate").onclick = r;
      });
      document.getElementById("animacyButtons").classList.add("hidden");
    } else {
      document.getElementById("primingStatus").textContent = "보세요";
      await new Promise(r => setTimeout(r, 2000));
    }
    img.classList.add("hidden");
    await new Promise(r => setTimeout(r, 200));

    // Target
    img.src = "./stim/" + trial.target_pic;
    img.classList.remove("hidden");
    document.getElementById("primingStatus").textContent = "빨리 말하세요!";
    
    const targetData = await recordThreeSeconds();
    
    // Timeout Handling
    if (targetData.onset === null) {
      timeoutCount++;
      if (timeoutCount >= FAIL_LIMIT) {
        alert("잦은 무응답으로 실험을 종료합니다.");
        location.reload();
        return;
      }
    }

    // Upload
    uploadAudioBlob(targetData.blob, {
      pid: session.pid, sessionId: session.sessionId, folderId: session.folderId,
      filename: `${session.pid}_T${i}_target.webm`, trialId: trial.pair_id, phase: "priming"
    }).catch(() => {
      uploadFailCount++;
      if (uploadFailCount >= FAIL_LIMIT) { alert("서버 오류로 중단합니다."); location.reload(); }
    });

    img.classList.add("hidden");
    document.getElementById("primingStatus").textContent = "";
    await new Promise(r => setTimeout(r, 800));
  }
  screens.priming.classList.add("hidden");
  screens.contact.classList.remove("hidden");
}

/* Contact Submission */
document.getElementById("btnSubmitContact").onclick = async () => {
  await jsonp({
    action: "appendContact",
    contact_json: JSON.stringify({ pid: session.pid, contact_value: document.getElementById("contactValue").value })
  });
  alert("완료되었습니다.");
  location.href = "about:blank";
};

</script>
</body>
</html>
