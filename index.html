<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Experiment</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .card { max-width: 760px; border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .hidden { display: none; }
    label { display:block; margin: 10px 0 6px; }
    input, select { width: 100%; padding: 8px; font-size: 16px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    .note { font-size: 14px; color:#444; }
    .loadingBox { margin-top: 12px; padding: 10px; background:#f7f7f7; border-radius:10px; }
    .spinner {
      display:inline-block; width:14px; height:14px;
      border:2px solid #ccc; border-top-color:#333;
      border-radius:50%; animation:spin 0.8s linear infinite;
      margin-right:8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
<h1>실험 참여</h1>

<!-- ================== 1. Consent + Participant Info ================== -->
<div class="card" id="screen-consent">
  <h2>연구 참여 동의</h2>
  <p>
    이 실험에서는 그림을 보고 단어를 말하거나 선택하는 과제를 하게 됩니다.
    각 단계마다 화면에 안내가 제시됩니다. 안내에 따라 진행해 주세요.

    실험은 여러 단계로 구성되어 있습니다.
    각 단계에서 집중해서 화면을 보고 반응해 주시기 바랍니다.
    정답 여부는 실험 중에 알려주지 않습니다.

    반응시간과 음성(녹음)이 수집될 수 있습니다.
    언제든 중단할 수 있으며, 동의하지 않으면 참여할 수 없습니다.
  </p>

  <label>
    <input type="checkbox" id="consentCheck">
    위 내용을 읽었고 연구 참여에 동의합니다.
  </label>

  <hr>

  <h3>참가자 정보</h3>

  <label>닉네임 / 이니셜 (2글자 이상)</label>
  <input id="nick" placeholder="예: HJ, MS (실명 X)">

  <label>생년월</label>
  <input id="birthYM" type="month">

  <label>모국어</label>
  <input id="nativeLang" placeholder="예: 한국어">

  <label>외국어(들)</label>
  <input id="otherLangs" placeholder="예: 영어, 일본어 (없으면 '없음')">

  <button id="btnStart" disabled>동의하고 시작</button>

  <div id="loading" class="loadingBox hidden">
    <div><span class="spinner"></span><b>세션을 준비 중입니다…</b></div>
    <div class="note">잠시만 기다려 주세요.</div>
  </div>
</div>

<!-- ================== 2. Ready (placeholder) ================== -->
<div class="card hidden" id="screen-ready">
  <h2>준비 완료</h2>
  <p>이제부터 실험을 시작합니다.</p>
  <button id="btnContinue">계속</button>
</div>

  <!-- ================== 2b. Study ================== -->
<div class="card hidden" id="screen-study">
  <h2>학습(Study)</h2>
  <p class="note" id="studyProgress">
    이 학습 단계에서는 그림과 함께 해당하는 단어를 미리 보여드립니다.
    이후 단계에서는 글자가 없이 그림만 제시되기 때문에,
    그림과 단어의 연결을 잘 익혀 주세요.  
    
    각 그림은 잠깐씩 자동으로 제시됩니다.
    화면에 나오는 그림과 단어를 그대로 보고 기억해 주세요.
    학습은 빠르게 2회 반복됩니다.

    학습이 끝나면, 다음 단계로 이동하는 버튼이 나타납니다.
  </p>

  <div style="text-align:center; margin-top:12px;">
    <div id="fixation" class="hidden" style="font-size:48px; line-height:80px;">+</div>
    <img id="studyImg" class="hidden" style="max-width:420px; max-height:320px;" />
    <div id="studyLabel" class="hidden" style="font-size:28px; margin-top:10px;"></div>
  </div>

  <button id="btnStartStudy" class="hidden">학습 시작</button>
  <button id="btnNextAfterStudy" class="hidden">다음(4지선다 테스트)</button>

</div>
  
<!-- ================== 2c. Study test- 4AFC ================== -->
<div class="card hidden" id="screen-afc">
  <h2>4지선다 테스트</h2>
  <p class="note" id="afcProgress"></p>

  <div style="text-align:center;">
    <img id="afcImg" style="max-width:420px; max-height:320px;" />
  </div>

  <div id="afcChoices" style="margin-top:16px;"></div>
  <p class="note" id="afcTimer"></p>

  <button id="btnNextAFC" class="hidden">다음</button>
</div>


<!-- ================== 3. Contact (PII separated) ================== -->
<div class="card hidden" id="screen-contact">
  <h2>보상용 연락처</h2>
  <p class="note">
    이 정보는 실험 데이터와 분리되어 저장되며,
    보상 지급 후 삭제됩니다.
  </p>

  <label for="contactValue">보상용 휴대폰 번호</label>
<input id="contactValue"
       placeholder="예: 010-1234-5678"
       inputmode="numeric"
       autocomplete="tel"
       autocorrect="off"
       autocapitalize="off" />
<div class="note">
  보상 발송 목적에만 사용되며, 실험 데이터와 분리 저장됩니다.
</div>

  <button id="btnSubmitContact">제출하고 종료</button>
</div>

<!-- ================== JS LOGIC ================== -->
<script type="module">
import { jsonp, createSession, appendRow } from "./js/api.js";

/* ---------- DOM ---------- */
const screenConsent = document.getElementById("screen-consent");
const screenReady   = document.getElementById("screen-ready");
const screenContact = document.getElementById("screen-contact");

const consentCheck = document.getElementById("consentCheck");
const nickEl = document.getElementById("nick");
const birthYMEl = document.getElementById("birthYM");
const nativeLangEl = document.getElementById("nativeLang");
const otherLangsEl = document.getElementById("otherLangs");
const btnStart = document.getElementById("btnStart");
const loadingEl = document.getElementById("loading");

const btnContinue = document.getElementById("btnContinue");
const contactTypeEl = document.getElementById("contactType");
const contactValueEl = document.getElementById("contactValue");
const btnSubmitContact = document.getElementById("btnSubmitContact");

const STUDY_ITEMS = [
  { itemId:"mushroom", img:"./stim/PICTURE_177.png", word:"버섯" },
  { itemId:"kitchen",  img:"./stim/PICTURE_730.png",  word:"부엌" },
  { itemId:"spider",   img:"./stim/PICTURE_38.png",   word:"거미" },
  { itemId:"stairs",   img:"./stim/PICTURE_500.png",   word:"계단" },
  { itemId:"apple",    img:"./stim/PICTURE_552.png",    word:"사과" },
  { itemId:"pizza",    img:"./stim/PICTURE_489.png",    word:"피자" }
];
  
const screenStudy = document.getElementById("screen-study");
const studyProgressEl = document.getElementById("studyProgress");
const fixationEl = document.getElementById("fixation");
const studyImgEl = document.getElementById("studyImg");
const studyLabelEl = document.getElementById("studyLabel");
const btnStartStudy = document.getElementById("btnStartStudy");
const btnNextAfterStudy = document.getElementById("btnNextAfterStudy");


const STUDY_TIMING = {
  fixation: 150,
  picOnly: 500,
  picPlusLabel: 500,
  iti: 50
};

const screenAFC = document.getElementById("screen-afc");
const afcImgEl = document.getElementById("afcImg");
const afcChoicesEl = document.getElementById("afcChoices");
const afcProgressEl = document.getElementById("afcProgress");
const afcTimerEl = document.getElementById("afcTimer");
const btnNextAFC = document.getElementById("btnNextAFC");

  /* =========================
   Study 실행 엔진
   ========================= */

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

async function runStudyPass(passNum) {
  const order = shuffle(STUDY_ITEMS);

  for (let t = 0; t < order.length; t++) {
    const it = order[t];
    studyProgressEl.textContent =
      `학습 ${passNum}/2 — ${t + 1}/${order.length}`;

    // fixation
    fixationEl.classList.remove("hidden");
    studyImgEl.classList.add("hidden");
    studyLabelEl.classList.add("hidden");
    await sleep(STUDY_TIMING.fixation);

    // picture only
    fixationEl.classList.add("hidden");
    studyImgEl.src = it.img;
    studyImgEl.classList.remove("hidden");
    const picOn = Date.now();
    await sleep(STUDY_TIMING.picOnly);

    // picture + label
    studyLabelEl.textContent = it.word;
    studyLabelEl.classList.remove("hidden");
    const labelOn = Date.now();
    await sleep(STUDY_TIMING.picPlusLabel);

    // clear
    studyImgEl.classList.add("hidden");
    studyLabelEl.classList.add("hidden");
    await sleep(STUDY_TIMING.iti);
  }
}

async function runStudy2Passes() {
  btnStartStudy.disabled = true;
  btnStartStudy.textContent = "학습 진행 중…";

  await appendRow({
    event: "study_start",
    ts_iso: new Date().toISOString(),
    pid: session.pid,
    sessionId: session.sessionId,
    phase: "study"
  });

  await runStudyPass(1);
  await sleep(400);
  await runStudyPass(2);

  await appendRow({
    event: "study_end",
    ts_iso: new Date().toISOString(),
    pid: session.pid,
    sessionId: session.sessionId,
    phase: "study"
  });

  studyProgressEl.textContent =
  "학습이 끝났습니다. 다음 단계로 이동해 주세요.";

  btnStartStudy.classList.add("hidden");
  btnNextAfterStudy.classList.remove("hidden");
  btnNextAfterStudy.disabled = false;


}
  
function getRandomDistractors(correctItem, allItems, n = 3) {
  const pool = allItems.filter(it => it.itemId !== correctItem.itemId);
  const shuffled = shuffle(pool);
  return shuffled.slice(0, n);
}

/* ---------- STATE ---------- */
let assignedGroup = null;   // overt / covert / nonaming (참가자에게 안 보임)
let session = null;

/* ---------- UTIL ---------- */
const show = el => el.classList.remove("hidden");
const hide = el => el.classList.add("hidden");

function generatePid() {
  const d = new Date();
  return "P" +
    d.toISOString().replace(/[-:.TZ]/g,"") +
    "-" + Math.random().toString(36).slice(2,6).toUpperCase();
}

function validateForm() {
  btnStart.disabled = !(
    consentCheck.checked &&
    nickEl.value.trim().length >= 2 &&
    /^\d{4}-\d{2}$/.test(birthYMEl.value) &&
    nativeLangEl.value.trim() &&
    otherLangsEl.value.trim()
  );
}

const AFC_TIME_LIMIT = 2000; // 2초
let afcOrder = [];
let afcIndex = 0;
let afcTimer = null;

function startAFC() {
  afcOrder = shuffle(STUDY_ITEMS);
  afcIndex = 0;

  appendRow({
    event: "afc_start",
    ts_iso: new Date().toISOString(),
    pid: session.pid,
    sessionId: session.sessionId,
    phase: "afc"
  });

  runNextAFCTrial();
}

function runNextAFCTrial() {
  if (afcIndex >= afcOrder.length) {
    endAFC();
    return;
  }

  const it = afcOrder[afcIndex];
  afcProgressEl.textContent =
    `문항 ${afcIndex + 1} / ${afcOrder.length}`;

  afcImgEl.src = it.img;

  // 선택지 구성
  const distractors = getRandomDistractors(it, STUDY_ITEMS, 3);
  const options = shuffle([
    { word: it.word, correct: true },
    ...distractors.map(d => ({ word: d.word, correct: false }))
  ]);

  afcChoicesEl.innerHTML = "";
  const trialStart = Date.now();

  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.textContent = opt.word;
    btn.style.display = "block";
    btn.style.margin = "8px auto";
    btn.onclick = () => {
      if (answered) return;
      answered = true;
      clearInterval(afcTimer);
      lockAFCTrial(opt, trialStart);
    };
    afcChoicesEl.appendChild(btn);
  });

  let remaining = AFC_TIME_LIMIT;
  afcTimerEl.textContent = `남은 시간: ${remaining} ms`;

  let answered = false;

  afcTimer = setInterval(() => {
    remaining -= 100;
    afcTimerEl.textContent = `남은 시간: ${remaining} ms`;
  
    if (remaining <= 0) {
      clearInterval(afcTimer);
      lockAFCTrial(null, trialStart); // ⬅ 자동 진행 X
    }
  }, 100);
}

function handleAFCResponse(opt, trialStart) {
  if (afcTimer) clearInterval(afcTimer);

  const rt = Date.now() - trialStart;
  const correct = opt ? opt.correct : false;
  const responseWord = opt ? opt.word : "";

  const it = afcOrder[afcIndex];

  appendRow({
    event: "afc_trial",
    ts_iso: new Date().toISOString(),
    pid: session.pid,
    sessionId: session.sessionId,
    primeModeGroup: assignedGroup,
    phase: "afc",
    trialIndex_phase: afcIndex + 1,
    itemId: it.itemId,
    targetWord: it.word,
    responseWord,
    correct,
    rt_ms: rt
  });

  afcIndex++;
  runNextAFCTrial();
}

function endAFC() {
  appendRow({
    event: "afc_end",
    ts_iso: new Date().toISOString(),
    pid: session.pid,
    sessionId: session.sessionId,
    phase: "afc"
  });

  alert("4지선다 테스트가 끝났습니다.");
  // 다음 단계: 오답 재학습 or 본 실험
}

function lockAFCTrial(opt, trialStart) {
  const rt = opt ? (Date.now() - trialStart) : null;
  const correct = opt ? opt.correct : false;
  const responseWord = opt ? opt.word : "";
  const timeout = opt === null;

  // 버튼 전부 비활성화
  [...afcChoicesEl.children].forEach(b => b.disabled = true);

  afcTimerEl.textContent = timeout
    ? "시간 초과 — 다음 버튼을 눌러 주세요."
    : "응답이 기록되었습니다.";

  const it = afcOrder[afcIndex];

  // 결과 저장 (여기서부터 핵심 데이터)
  appendRow({
    event: "afc_trial",
    ts_iso: new Date().toISOString(),
    pid: session.pid,
    sessionId: session.sessionId,
    primeModeGroup: assignedGroup,
    phase: "afc",
    trialIndex_phase: afcIndex + 1,
    itemId: it.itemId,
    targetWord: it.word,
    responseWord,
    correct,
    timeout,
    rt_ms: rt
  });

  // Next 버튼 활성화
  btnNextAFC.classList.remove("hidden");
  btnNextAFC.disabled = false;
}

/* ---------- GROUP ASSIGNMENT (silent) ---------- */
async function assignPrimeMode() {
  try {
    const res = await jsonp({ action:"getGroupCounts" });
    const c = res.counts;
    const groups = ["overt","covert","nonaming"];
    const min = Math.min(...groups.map(g=>c[g]||0));
    const mins = groups.filter(g=>(c[g]||0)===min);
    return Math.random()<0.8
      ? mins[Math.floor(Math.random()*mins.length)]
      : groups[Math.floor(Math.random()*3)];
  } catch {
    return ["overt","covert","nonaming"][Math.floor(Math.random()*3)];
  }
}
assignPrimeMode().then(g=>assignedGroup=g);

/* ---------- EVENTS ---------- */
[consentCheck,nickEl,birthYMEl,nativeLangEl,otherLangsEl]
  .forEach(el=>{
    el.addEventListener("input",validateForm);
    el.addEventListener("change",validateForm);
  });

btnStart.onclick = async () => {
  btnStart.disabled = true;
  show(loadingEl);

  const pid = generatePid();
  const participant = {
    nick: nickEl.value.trim(),
    birthYM: birthYMEl.value,
    nativeLang: nativeLangEl.value.trim(),
    otherLangs: otherLangsEl.value.trim()
  };

  session = await createSession(pid, {
    primeModeGroup: assignedGroup,
    participant
  });

  await appendRow({
    event:"participant_info",
    ts_iso:new Date().toISOString(),
    pid:session.pid,
    sessionId:session.sessionId,
    primeModeGroup:assignedGroup,
    participant_nick:participant.nick,
    participant_birthYM:participant.birthYM,
    participant_nativeLang:participant.nativeLang,
    participant_otherLangs:participant.otherLangs
  });

  hide(screenConsent);
  hide(loadingEl);
  show(screenReady);
};

btnContinue.onclick = () => {
  hide(screenReady);
  show(screenStudy);
  btnStartStudy.classList.remove("hidden");
};

btnStartStudy.onclick = async () => {
  try {
    await runStudy2Passes();
    // TODO: 다음 단계 (4AFC)로 화면 전환
  } catch (e) {
    alert("학습 중 오류가 발생했습니다.\n" + e.message);
    btnStartStudy.disabled = false;
    btnStartStudy.textContent = "학습 시작";
  }
};

btnNextAfterStudy.onclick = () => {
  hide(screenStudy);
  show(screenAFC);   
  startAFC();        
};
  
btnSubmitContact.onclick = async () => {
  const phone = contactValueEl.value.trim();
  const phoneOk = /^01[016789]-?\d{3,4}-?\d{4}$/.test(phone);

  if (!phoneOk) {
    alert("보상 기프티콘을 받을 휴대폰 번호를 정확히 입력해 주세요.\n예: 010-1234-5678");
    return;
  }

  btnSubmitContact.disabled = true; // 🔒 잠금

  try {
    await jsonp({
      action: "appendContact",
      contact_json: JSON.stringify({
        pid: session.pid,
        sessionId: session.sessionId,
        contact_type: "phone",
        contact_value: phone
      })
    });

    alert("제출이 완료되었습니다. 참여해 주셔서 감사합니다!");
    window.location.href = "about:blank";

  } catch (e) {
    btnSubmitContact.disabled = false; // 실패 시 복구
    alert("연락처 저장 중 오류가 발생했습니다.\n" + e.message);
  }
};

btnNextAFC.onclick = () => {
btnNextAFC.classList.add("hidden");
afcIndex++;
runNextAFCTrial();
};

</script>
</body>
</html>






