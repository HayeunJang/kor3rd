<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Experiment</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .card { max-width: 760px; border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .hidden { display: none; }
    label { display:block; margin: 10px 0 6px; }
    input, select { width: 100%; padding: 8px; font-size: 16px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    .note { font-size: 14px; color:#444; }
    .loadingBox { margin-top: 12px; padding: 10px; background:#f7f7f7; border-radius:10px; }
    .spinner {
      display:inline-block; width:14px; height:14px;
      border:2px solid #ccc; border-top-color:#333;
      border-radius:50%; animation:spin 0.8s linear infinite;
      margin-right:8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
<h1>ì‹¤í—˜ ì°¸ì—¬</h1>

<!-- ================== 1. Consent + Participant Info ================== -->
<div class="card" id="screen-consent">
  <h2>ì—°êµ¬ ì°¸ì—¬ ë™ì˜</h2>
  <p>
    ë³¸ ì—°êµ¬ëŠ” ê·¸ë¦¼ì„ ë³´ê³  ë‹¨ì–´ë¥¼ ë§í•˜ëŠ” ê³¼ì œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
    ë°˜ì‘ì‹œê°„ê³¼ ìŒì„±(ë…¹ìŒ)ì´ ìˆ˜ì§‘ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    ì–¸ì œë“  ì¤‘ë‹¨í•  ìˆ˜ ìˆìœ¼ë©°, ë™ì˜í•˜ì§€ ì•Šìœ¼ë©´ ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
  </p>

  <label>
    <input type="checkbox" id="consentCheck">
    ìœ„ ë‚´ìš©ì„ ì½ì—ˆê³  ì—°êµ¬ ì°¸ì—¬ì— ë™ì˜í•©ë‹ˆë‹¤.
  </label>

  <hr>

  <h3>ì°¸ê°€ì ì •ë³´</h3>

  <label>ë‹‰ë„¤ì„ / ì´ë‹ˆì…œ (2ê¸€ì ì´ìƒ)</label>
  <input id="nick" placeholder="ì˜ˆ: HJ, MS (ì‹¤ëª… X)">

  <label>ìƒë…„ì›”</label>
  <input id="birthYM" type="month">

  <label>ëª¨êµ­ì–´</label>
  <input id="nativeLang" placeholder="ì˜ˆ: í•œêµ­ì–´">

  <label>ì™¸êµ­ì–´(ë“¤)</label>
  <input id="otherLangs" placeholder="ì˜ˆ: ì˜ì–´, ì¼ë³¸ì–´ (ì—†ìœ¼ë©´ 'ì—†ìŒ')">

  <button id="btnStart" disabled>ë™ì˜í•˜ê³  ì‹œì‘</button>

  <div id="loading" class="loadingBox hidden">
    <div><span class="spinner"></span><b>ì„¸ì…˜ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤â€¦</b></div>
    <div class="note">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
  </div>
</div>

<!-- ================== 2. Ready (placeholder) ================== -->
<div class="card hidden" id="screen-ready">
  <h2>ì¤€ë¹„ ì™„ë£Œ</h2>
  <p>ì´ì œë¶€í„° ì‹¤í—˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>
  <button id="btnContinue">ê³„ì†</button>
</div>

<!-- ================== 3. Contact (PII separated) ================== -->
<div class="card hidden" id="screen-contact">
  <h2>ë³´ìƒìš© ì—°ë½ì²˜</h2>
  <p class="note">
    ì´ ì •ë³´ëŠ” ì‹¤í—˜ ë°ì´í„°ì™€ ë¶„ë¦¬ë˜ì–´ ì €ì¥ë˜ë©°,
    ë³´ìƒ ì§€ê¸‰ í›„ ì‚­ì œë©ë‹ˆë‹¤.
  </p>

  <label for="contactValue">ë³´ìƒìš© íœ´ëŒ€í° ë²ˆí˜¸</label>
<input id="contactValue"
       placeholder="ì˜ˆ: 010-1234-5678"
       inputmode="numeric"
       autocomplete="tel"
       autocorrect="off"
       autocapitalize="off" />
<div class="note">
  ë³´ìƒ ë°œì†¡ ëª©ì ì—ë§Œ ì‚¬ìš©ë˜ë©°, ì‹¤í—˜ ë°ì´í„°ì™€ ë¶„ë¦¬ ì €ì¥ë©ë‹ˆë‹¤.
</div>

  <button id="btnSubmitContact">ì œì¶œí•˜ê³  ì¢…ë£Œ</button>
</div>

<!-- ================== JS LOGIC ================== -->
<script type="module">
import { jsonp, createSession, appendRow } from "./js/api.js";

/* ---------- DOM ---------- */
const screenConsent = document.getElementById("screen-consent");
const screenReady   = document.getElementById("screen-ready");
const screenContact = document.getElementById("screen-contact");

const consentCheck = document.getElementById("consentCheck");
const nickEl = document.getElementById("nick");
const birthYMEl = document.getElementById("birthYM");
const nativeLangEl = document.getElementById("nativeLang");
const otherLangsEl = document.getElementById("otherLangs");
const btnStart = document.getElementById("btnStart");
const loadingEl = document.getElementById("loading");

const btnContinue = document.getElementById("btnContinue");
const contactTypeEl = document.getElementById("contactType");
const contactValueEl = document.getElementById("contactValue");
const btnSubmitContact = document.getElementById("btnSubmitContact");

/* ---------- STATE ---------- */
let assignedGroup = null;   // overt / covert / nonaming (ì°¸ê°€ìì—ê²Œ ì•ˆ ë³´ì„)
let session = null;

/* ---------- UTIL ---------- */
const show = el => el.classList.remove("hidden");
const hide = el => el.classList.add("hidden");

function generatePid() {
  const d = new Date();
  return "P" +
    d.toISOString().replace(/[-:.TZ]/g,"") +
    "-" + Math.random().toString(36).slice(2,6).toUpperCase();
}

function validateForm() {
  btnStart.disabled = !(
    consentCheck.checked &&
    nickEl.value.trim().length >= 2 &&
    /^\d{4}-\d{2}$/.test(birthYMEl.value) &&
    nativeLangEl.value.trim() &&
    otherLangsEl.value.trim()
  );
}

/* ---------- GROUP ASSIGNMENT (silent) ---------- */
async function assignPrimeMode() {
  try {
    const res = await jsonp({ action:"getGroupCounts" });
    const c = res.counts;
    const groups = ["overt","covert","nonaming"];
    const min = Math.min(...groups.map(g=>c[g]||0));
    const mins = groups.filter(g=>(c[g]||0)===min);
    return Math.random()<0.8
      ? mins[Math.floor(Math.random()*mins.length)]
      : groups[Math.floor(Math.random()*3)];
  } catch {
    return ["overt","covert","nonaming"][Math.floor(Math.random()*3)];
  }
}
assignPrimeMode().then(g=>assignedGroup=g);

/* ---------- EVENTS ---------- */
[consentCheck,nickEl,birthYMEl,nativeLangEl,otherLangsEl]
  .forEach(el=>{
    el.addEventListener("input",validateForm);
    el.addEventListener("change",validateForm);
  });

btnStart.onclick = async () => {
  btnStart.disabled = true;
  show(loadingEl);

  const pid = generatePid();
  const participant = {
    nick: nickEl.value.trim(),
    birthYM: birthYMEl.value,
    nativeLang: nativeLangEl.value.trim(),
    otherLangs: otherLangsEl.value.trim()
  };

  session = await createSession(pid, {
    primeModeGroup: assignedGroup,
    participant
  });

  await appendRow({
    event:"participant_info",
    ts_iso:new Date().toISOString(),
    pid:session.pid,
    sessionId:session.sessionId,
    primeModeGroup:assignedGroup,
    participant_nick:participant.nick,
    participant_birthYM:participant.birthYM,
    participant_nativeLang:participant.nativeLang,
    participant_otherLangs:participant.otherLangs
  });

  hide(screenConsent);
  hide(loadingEl);
  show(screenReady);
};

btnContinue.onclick = () => {
  hide(screenReady);
  show(screenContact);
};

btnSubmitContact.onclick = async () => {
  const phone = contactValueEl.value.trim();
  const phoneOk = /^01[016789]-?\d{3,4}-?\d{4}$/.test(phone);

  if (!phoneOk) {
    alert("ë³´ìƒ ê¸°í”„í‹°ì½˜ì„ ë°›ì„ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.\nì˜ˆ: 010-1234-5678");
    return;
  }

  btnSubmitContact.disabled = true; // ğŸ”’ ì ê¸ˆ

  try {
    await jsonp({
      action: "appendContact",
      contact_json: JSON.stringify({
        pid: session.pid,
        sessionId: session.sessionId,
        contact_type: "phone",
        contact_value: phone
      })
    });

    alert("ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!");
    window.location.href = "about:blank";

  } catch (e) {
    btnSubmitContact.disabled = false; // ì‹¤íŒ¨ ì‹œ ë³µêµ¬
    alert("ì—°ë½ì²˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + e.message);
  }
};


</script>
</body>
</html>

