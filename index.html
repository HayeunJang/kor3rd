<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Experiment – Start</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .card { max-width: 760px; border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .hidden { display: none; }
    label { display:block; margin: 10px 0 6px; }
    input, select { width: 100%; padding: 8px; font-size: 16px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    pre { background:#f7f7f7; padding:12px; border-radius: 8px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Experiment</h1>

  <!-- (선택) 디버그 로그: 필요 없으면 카드 전체 삭제 -->
  <div class="card">
    <div><b>Status:</b> <span id="status">loading…</span></div>
    <pre id="log"></pre>
  </div>

  <!-- 1) Consent + 참가자정보 (첫 화면) -->
  <div class="card" id="screen-consent">
    <h2>연구 참여 동의</h2>
    <p style="line-height:1.5">
      본 연구는 그림을 보고 단어를 말하는 과제를 포함합니다. 응답 시간 및 음성(녹음)이 수집될 수 있습니다.
      언제든 중단할 수 있으며, 동의하지 않으면 참여할 수 없습니다.
    </p>

    <label>
      <input type="checkbox" id="consentCheck"/>
      위 내용을 읽었고 연구 참여에 동의합니다.
    </label>

    <hr/>

    <h3>참가자 정보</h3>

    <label for="pid">참가자 ID(임의 코드)</label>
    <input id="pid" placeholder="예: P001 (이름/이메일 말고 임의 코드)" />

    <div class="row">
      <div>
        <label for="age">나이</label>
        <input id="age" type="number" min="1" max="120" placeholder="예: 23" />
      </div>
      <div>
        <label for="gender">성별</label>
        <select id="gender">
          <option value="">선택</option>
          <option value="F">여성</option>
          <option value="M">남성</option>
          <option value="X">기타/응답안함</option>
        </select>
      </div>
    </div>

    <label for="device">기기/브라우저(선택)</label>
    <input id="device" placeholder="예: Windows Edge, Mac Chrome 등 (선택)" />

    <button id="btnStart" disabled>동의 완료 & 세션 시작</button>
  </div>

  <!-- 2) 세션 준비 완료 -->
  <div class="card hidden" id="screen-ready">
    <h2>세션 생성 완료</h2>
    <p>이제 Study/4AFC/본 실험을 시작할 수 있습니다.</p>
    <p><b>sessionId</b>: <span id="sessionIdText"></span></p>
    <p><b>folderId</b>: <span id="folderIdText"></span></p>

    <!-- 테스트용: row 하나 저장 -->
    <button id="btnTestRow">테스트 row 저장(POST)</button>
  </div>

<script type="module">
import { jsonp, createSession, appendRow } from "./js/api.js";

const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");

const screenConsent = document.getElementById("screen-consent");
const screenReady = document.getElementById("screen-ready");

const consentCheck = document.getElementById("consentCheck");
const pidEl = document.getElementById("pid");
const ageEl = document.getElementById("age");
const genderEl = document.getElementById("gender");
const deviceEl = document.getElementById("device");
const btnStart = document.getElementById("btnStart");

const sessionIdText = document.getElementById("sessionIdText");
const folderIdText = document.getElementById("folderIdText");
const btnTestRow = document.getElementById("btnTestRow");

let assignedGroup = null; // overt / covert / nonaming (참가자에게 표시 안 함)
let session = null;

function log(x) {
  logEl.textContent += (typeof x === "string" ? x : JSON.stringify(x, null, 2)) + "\n";
}
function setStatus(s) { statusEl.textContent = s; }
function show(el) { el.classList.remove("hidden"); }
function hide(el) { el.classList.add("hidden"); }

function validateConsentForm() {
  const ok =
    consentCheck.checked &&
    pidEl.value.trim().length >= 2 &&
    ageEl.value.trim() !== "" &&
    Number(ageEl.value) >= 1 &&
    genderEl.value !== "";
  btnStart.disabled = !ok;
}

/** 3번(biased-coin minimization): 최소그룹을 80% 확률로 선택 */
async function assignPrimeModeBiasedCoin() {
  // api.js의 jsonp가 params.secret을 자동으로 붙이도록 되어 있어야 함
  const res = await jsonp({ action:"getGroupCounts" });
  if (!res.ok) throw new Error(res.error || "getGroupCounts failed");

  const c = res.counts;
  const groups = ["overt","covert","nonaming"];
  const min = Math.min(...groups.map(g => c[g] ?? 0));
  const mins = groups.filter(g => (c[g] ?? 0) === min);

  const pBias = 0.8;
  if (Math.random() < pBias) return mins[Math.floor(Math.random() * mins.length)];
  return groups[Math.floor(Math.random() * groups.length)];
}

/** 페이지 로드 시 백그라운드로 그룹 배정만 해둠(표시/저장 X) */
async function initAssignmentSilent() {
  setStatus("loading…");
  try {
    assignedGroup = await assignPrimeModeBiasedCoin();
    log({ assignedGroup, note:"assigned silently (not shown, not saved)" });
    setStatus("ready for consent");
  } catch(e) {
    // 배정 실패해도 실험 자체는 진행 가능하게(최후 fallback: 완전 랜덤)
    const fallback = ["overt","covert","nonaming"];
    assignedGroup = fallback[Math.floor(Math.random()*fallback.length)];
    log("WARN: assignment failed, fallback random. " + e.message);
    log({ assignedGroup, note:"fallback random" });
    setStatus("ready for consent");
  }
}

[consentCheck, pidEl, ageEl, genderEl].forEach(el => {
  el.addEventListener("input", validateConsentForm);
  el.addEventListener("change", validateConsentForm);
});

btnStart.onclick = async () => {
  try {
    setStatus("creating session…");

    const pid = pidEl.value.trim();
    const extraMeta = {
      primeModeGroup: assignedGroup,  // 참가자에게는 비공개, 서버엔 저장됨
      age: Number(ageEl.value),
      gender: genderEl.value,
      device: deviceEl.value.trim() || "",
      assignedAt_iso: new Date().toISOString()
    };

    // ✅ consent 후에만 세션 생성/저장
    session = await createSession(pid, extraMeta);
    log({ session });

    sessionIdText.textContent = session.sessionId;
    folderIdText.textContent = session.folderId;

    // 참가자정보 저장(원하면 빼도 됨)
    await appendRow({
      event: "participant_info",
      ts_iso: new Date().toISOString(),
      pid: session.pid,
      sessionId: session.sessionId,
      folderId: session.folderId,
      primeModeGroup: assignedGroup,
      phase: "consent",
      extraMeta_json: JSON.stringify(extraMeta)
    });

    hide(screenConsent);
    show(screenReady);
    setStatus("session ready");
  } catch(e) {
    setStatus("ERROR creating session");
    log("ERROR: " + e.message);
  }
};

btnTestRow.onclick = async () => {
  try {
    if (!session) throw new Error("no session");
    const out = await appendRow({
      event: "trial",
      ts_iso: new Date().toISOString(),
      pid: session.pid,
      sessionId: session.sessionId,
      folderId: session.folderId,
      primeModeGroup: assignedGroup,
      phase: "test",
      notes: "test row from ready screen"
    });
    log(out);
    setStatus("test row saved");
  } catch(e) {
    setStatus("ERROR saving test row");
    log("ERROR: " + e.message);
  }
};

// 시작: 조용히 배정만 해둠
validateConsentForm();
initAssignmentSilent();
</script>
</body>
</html>
