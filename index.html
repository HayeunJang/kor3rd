<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Experiment</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .card { max-width: 760px; border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .hidden { display: none; }
    label { display:block; margin: 10px 0 6px; }
    input, select { width: 100%; padding: 8px; font-size: 16px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    .note { font-size: 14px; color:#444; }
    .loadingBox { margin-top: 12px; padding: 10px; background:#f7f7f7; border-radius:10px; }
    .spinner {
      display:inline-block; width:14px; height:14px;
      border:2px solid #ccc; border-top-color:#333;
      border-radius:50%; animation:spin 0.8s linear infinite;
      margin-right:8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
<h1>실험 참여</h1>

<!-- ================== 1. Consent + Participant Info ================== -->
<div class="card" id="screen-consent">
  <h2>연구 참여 동의</h2>
  <p>
    본 연구는 그림을 보고 단어를 말하는 과제를 포함합니다.
    반응시간과 음성(녹음)이 수집될 수 있습니다.
    언제든 중단할 수 있으며, 동의하지 않으면 참여할 수 없습니다.
  </p>

  <label>
    <input type="checkbox" id="consentCheck">
    위 내용을 읽었고 연구 참여에 동의합니다.
  </label>

  <hr>

  <h3>참가자 정보</h3>

  <label>닉네임 / 이니셜 (2글자 이상)</label>
  <input id="nick" placeholder="예: HJ, MS (실명 X)">

  <label>생년월</label>
  <input id="birthYM" type="month">

  <label>모국어</label>
  <input id="nativeLang" placeholder="예: 한국어">

  <label>외국어(들)</label>
  <input id="otherLangs" placeholder="예: 영어, 일본어 (없으면 '없음')">

  <button id="btnStart" disabled>동의하고 시작</button>

  <div id="loading" class="loadingBox hidden">
    <div><span class="spinner"></span><b>세션을 준비 중입니다…</b></div>
    <div class="note">잠시만 기다려 주세요.</div>
  </div>
</div>

<!-- ================== 2. Ready (placeholder) ================== -->
<div class="card hidden" id="screen-ready">
  <h2>준비 완료</h2>
  <p>이제부터 실험을 시작합니다.</p>
  <button id="btnContinue">계속</button>
</div>

<!-- ================== 3. Contact (PII separated) ================== -->
<div class="card hidden" id="screen-contact">
  <h2>보상용 연락처</h2>
  <p class="note">
    이 정보는 실험 데이터와 분리되어 저장되며,
    보상 지급 후 삭제됩니다.
  </p>

  <label>연락 방법</label>
  <select id="contactType">
    <option value="">선택</option>
    <option value="phone">전화번호</option>
    <option value="email">이메일</option>
  </select>

  <label>연락처</label>
  <input id="contactValue">

  <button id="btnSubmitContact">제출하고 종료</button>
</div>

<!-- ================== JS LOGIC ================== -->
<script type="module">
import { jsonp, createSession, appendRow } from "./js/api.js";

/* ---------- DOM ---------- */
const screenConsent = document.getElementById("screen-consent");
const screenReady   = document.getElementById("screen-ready");
const screenContact = document.getElementById("screen-contact");

const consentCheck = document.getElementById("consentCheck");
const nickEl = document.getElementById("nick");
const birthYMEl = document.getElementById("birthYM");
const nativeLangEl = document.getElementById("nativeLang");
const otherLangsEl = document.getElementById("otherLangs");
const btnStart = document.getElementById("btnStart");
const loadingEl = document.getElementById("loading");

const btnContinue = document.getElementById("btnContinue");
const contactTypeEl = document.getElementById("contactType");
const contactValueEl = document.getElementById("contactValue");
const btnSubmitContact = document.getElementById("btnSubmitContact");

/* ---------- STATE ---------- */
let assignedGroup = null;   // overt / covert / nonaming (참가자에게 안 보임)
let session = null;

/* ---------- UTIL ---------- */
const show = el => el.classList.remove("hidden");
const hide = el => el.classList.add("hidden");

function generatePid() {
  const d = new Date();
  return "P" +
    d.toISOString().replace(/[-:.TZ]/g,"") +
    "-" + Math.random().toString(36).slice(2,6).toUpperCase();
}

function validateForm() {
  btnStart.disabled = !(
    consentCheck.checked &&
    nickEl.value.trim().length >= 2 &&
    /^\d{4}-\d{2}$/.test(birthYMEl.value) &&
    nativeLangEl.value.trim() &&
    otherLangsEl.value.trim()
  );
}

/* ---------- GROUP ASSIGNMENT (silent) ---------- */
async function assignPrimeMode() {
  try {
    const res = await jsonp({ action:"getGroupCounts" });
    const c = res.counts;
    const groups = ["overt","covert","nonaming"];
    const min = Math.min(...groups.map(g=>c[g]||0));
    const mins = groups.filter(g=>(c[g]||0)===min);
    return Math.random()<0.8
      ? mins[Math.floor(Math.random()*mins.length)]
      : groups[Math.floor(Math.random()*3)];
  } catch {
    return ["overt","covert","nonaming"][Math.floor(Math.random()*3)];
  }
}
assignPrimeMode().then(g=>assignedGroup=g);

/* ---------- EVENTS ---------- */
[consentCheck,nickEl,birthYMEl,nativeLangEl,otherLangsEl]
  .forEach(el=>{
    el.addEventListener("input",validateForm);
    el.addEventListener("change",validateForm);
  });

btnStart.onclick = async () => {
  btnStart.disabled = true;
  show(loadingEl);

  const pid = generatePid();
  const participant = {
    nick: nickEl.value.trim(),
    birthYM: birthYMEl.value,
    nativeLang: nativeLangEl.value.trim(),
    otherLangs: otherLangsEl.value.trim()
  };

  session = await createSession(pid, {
    primeModeGroup: assignedGroup,
    participant
  });

  await appendRow({
    event:"participant_info",
    ts_iso:new Date().toISOString(),
    pid:session.pid,
    sessionId:session.sessionId,
    primeModeGroup:assignedGroup,
    participant_nick:participant.nick,
    participant_birthYM:participant.birthYM,
    participant_nativeLang:participant.nativeLang,
    participant_otherLangs:participant.otherLangs
  });

  hide(screenConsent);
  hide(loadingEl);
  show(screenReady);
};

btnContinue.onclick = () => {
  hide(screenReady);
  show(screenContact);
};

btnSubmitContact.onclick = async () => {
  if (!contactTypeEl.value || !contactValueEl.value.trim()) {
    alert("연락처를 입력해 주세요.");
    return;
  }
  await jsonp({
    action:"appendContact",
    contact_json: JSON.stringify({
      pid: session.pid,
      sessionId: session.sessionId,
      contact_type: contactTypeEl.value,
      contact_value: contactValueEl.value.trim()
    })
  });
  alert("제출이 완료되었습니다. 감사합니다!");
  window.location.href="about:blank";
};
</script>
</body>
</html>
