<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Experiment</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .card { max-width: 760px; border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .hidden { display: none; }
    label { display:block; margin: 10px 0 6px; }
    input, select { width: 100%; padding: 8px; font-size: 16px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    .note { color:#444; font-size: 14px; line-height: 1.4; }
    .loadingBox { margin-top: 12px; padding: 10px; border-radius: 10px; background: #f7f7f7; }
    .spinner {
      display:inline-block; width: 14px; height: 14px;
      border: 2px solid #ccc; border-top-color: #333;
      border-radius: 50%; animation: spin 0.8s linear infinite;
      vertical-align: -2px; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>
<body>
  <h1>실험 참여</h1>

  <!-- 1) Consent + 참가자정보 (첫 화면) -->
  <div class="card" id="screen-consent">
    <h2>연구 참여 동의</h2>
    <p style="line-height:1.5">
      본 연구는 그림을 보고 단어를 말하는 과제를 포함합니다. 응답 시간 및 음성(녹음)이 수집될 수 있습니다.
      언제든 중단할 수 있으며, 동의하지 않으면 참여할 수 없습니다.
    </p>

    <label>
      <input type="checkbox" id="consentCheck"/>
      위 내용을 읽었고 연구 참여에 동의합니다.
    </label>

    <hr/>

    <h3>참가자 정보</h3>

    <label for="nick">닉네임/이니셜 (2글자 이상)</label>
    <input id="nick" placeholder="예: HJ, 민수 (실명 X)" />

    <label for="birthYM">생년월 (YYYY-MM)</label>
    <input id="birthYM" type="month" placeholder="YYYY-MM" />

    <label for="nativeLang">모국어</label>
    <input id="nativeLang" placeholder="예: 한국어" />

    <label for="otherLangs">외국어(들)</label>
    <input id="otherLangs" placeholder="예: 영어, 일본어 (없으면 '없음')" />
    <div class="note">여러 개면 쉼표로 구분해서 적어주세요.</div>

    <button id="btnStart" disabled>동의하고 시작</button>

    <div id="loading" class="loadingBox hidden">
      <div><span class="spinner"></span><b>세션을 준비 중입니다…</b></div>
      <div class="note">잠시만 기다려 주세요. (데이터 저장/폴더 생성 중)</div>
    </div>
  </div>

  <!-- 2) 다음 단계(지금은 placeholder) -->
  <div class="card hidden" id="screen-ready">
    <h2>준비 완료</h2>
    <p>이제 Study 단계로 진행합니다.</p>
    <button id="btnContinue">계속</button>
  </div>

<script type="module">
import { jsonp, createSession, appendRow } from "./js/api.js";

const screenConsent = document.getElementById("screen-consent");
const screenReady = document.getElementById("screen-ready");

const consentCheck = document.getElementById("consentCheck");
const nickEl = document.getElementById("nick");
const birthYMEl = document.getElementById("birthYM");
const nativeLangEl = document.getElementById("nativeLang");
const otherLangsEl = document.getElementById("otherLangs");
const btnStart = document.getElementById("btnStart");
const loadingEl = document.getElementById("loading");

const btnContinue = document.getElementById("btnContinue");

let assignedGroup = null; // overt / covert / nonaming (참가자에게 표시 안 함)
let session = null;

// pid 자동 생성: P + YYYYMMDD-HHMMSS + 랜덤4자리
function generatePid_() {
  const d = new Date();
  const pad = (n) => String(n).padStart(2, "0");
  const ymd = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
  const hms = `${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  const rnd = Math.random().toString(36).slice(2, 6).toUpperCase();
  return `P${ymd}-${hms}-${rnd}`;
}

function show(el) { el.classList.remove("hidden"); }
function hide(el) { el.classList.add("hidden"); }

function validBirthYM_(v) {
  return /^\d{4}-\d{2}$/.test(v);
}

function validateForm() {
  const ok =
    consentCheck.checked &&
    nickEl.value.trim().length >= 2 &&
    validBirthYM_(birthYMEl.value.trim()) &&
    nativeLangEl.value.trim().length >= 1 &&
    otherLangsEl.value.trim().length >= 1;
  btnStart.disabled = !ok;
}

/** 3번(biased-coin minimization): 최소그룹을 80% 확률로 선택 */
async function assignPrimeModeBiasedCoin() {
  // api.js의 jsonp가 params.secret 자동 포함이어야 함
  const res = await jsonp({ action:"getGroupCounts" });
  if (!res.ok) throw new Error(res.error || "getGroupCounts failed");

  const c = res.counts;
  const groups = ["overt","covert","nonaming"];
  const min = Math.min(...groups.map(g => c[g] ?? 0));
  const mins = groups.filter(g => (c[g] ?? 0) === min);

  const pBias = 0.8;
  if (Math.random() < pBias) return mins[Math.floor(Math.random() * mins.length)];
  return groups[Math.floor(Math.random() * groups.length)];
}

// 페이지 로드 시 조용히 배정만 해둠(표시/저장 X)
(async function initAssignmentSilent(){
  try {
    assignedGroup = await assignPrimeModeBiasedCoin();
  } catch(e) {
    const fallback = ["overt","covert","nonaming"];
    assignedGroup = fallback[Math.floor(Math.random()*fallback.length)];
  }
})();

[consentCheck, nickEl, birthYMEl, nativeLangEl, otherLangsEl].forEach(el => {
  el.addEventListener("input", validateForm);
  el.addEventListener("change", validateForm);
});

btnStart.onclick = async () => {
  // 중복 클릭 방지 + 로딩 표시
  btnStart.disabled = true;
  show(loadingEl);

  try {
    const pid = generatePid_();

    const participant = {
      nick: nickEl.value.trim(),          // 실명 X
      birthYM: birthYMEl.value.trim(),    // YYYY-MM
      nativeLang: nativeLangEl.value.trim(),
      otherLangs: otherLangsEl.value.trim()
    };

    const extraMeta = {
      primeModeGroup: assignedGroup,
      participant
    };

    // ✅ 동의 후 세션 생성(=서버 저장 시작)
    session = await createSession(pid, extraMeta);

    // 참가자정보 저장(본 시트)
    await appendRow({
      event: "participant_info",
      ts_iso: new Date().toISOString(),
      pid: session.pid,
      sessionId: session.sessionId,
      folderId: session.folderId,
      primeModeGroup: assignedGroup,
      participant_nick: participant.nick,
      participant_birthYM: participant.birthYM,
      participant_nativeLang: participant.nativeLang,
      participant_otherLangs: participant.otherLangs
    });

    // 다음 화면으로
    hide(screenConsent);
    hide(loadingEl);
    show(screenReady);

  } catch(e) {
    hide(loadingEl);
    alert("시작 중 오류가 발생했습니다. 새로고침 후 다시 시도해주세요.\n\n" + e.message);
    // 폼 유효하면 다시 누를 수 있게
    validateForm();
  }
};

btnContinue.onclick = () => {
  // 다음 단계에서 여기서 Study로 넘어가게 만들면 됨
  alert("다음 단계(Study)로 넘어갈 준비 완료. 이제 Study UI를 붙이면 됩니다.");
};

validateForm();
</script>
</body>
</html>
