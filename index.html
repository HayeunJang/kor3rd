<script type="module">
import { jsonp, createSession, appendRow, uploadAudioBlob } from "./js/api.js";

/* 글로벌 상태 */
let session = null, assignedGroup = null, STUDY_ITEMS = [], PRIMING_TRIALS = [];
let timeoutCount = 0, uploadFailCount = 0, listNumUsed = 0;
let afcIdx = 0, afcScore = 0, afcResponses = [], afcWrongItems = [], isRemedial = false;
const FAIL_LIMIT = 10, TOTAL_PRIMING = 108, AFC_THRESHOLD = 0.9;

/* 1. 세션 시작 및 정보 저장 */
document.getElementById("btnStart").onclick = async () => {
  listNumUsed = Math.floor(Math.random() * 3) + 1;
  const [itemsData, pairsData] = await Promise.all([
    fetch("./stim/items.csv").then(r => r.text()).then(parseCSV),
    fetch(`./stim/pairs_list_${listNumUsed}.csv`).then(r => r.text()).then(parseCSV)
  ]);

  const usedIds = new Set();
  pairsData.forEach(p => { usedIds.add(p.primeId); usedIds.add(p.targetId); });
  STUDY_ITEMS = itemsData.filter(i => usedIds.has(i.itemId)).map(i => ({...i, img: "./stim/"+i.img}));
  PRIMING_TRIALS = pairsData;
  assignedGroup = ["overt", "covert", "nonaming"][Math.floor(Math.random() * 3)];
  
  // 참가자 상세 정보 객체
  const participant = { 
    nick: document.getElementById("nick").value, 
    birthYM: document.getElementById("birthYM").value, 
    gender: document.getElementById("gender").value,
    nativeLang: document.getElementById("nativeLang").value,
    otherLangs: document.getElementById("otherLangs").value
  };

  // session_start 이벤트와 함께 모든 정보 저장
  session = await createSession(participant.nick + "_" + Date.now(), { 
    primeModeGroup: assignedGroup, 
    listNum: listNumUsed,
    participant: participant 
  });
  
  showScreen("ready");
};

/* 2. 4AFC 테스트 결과 저장 추가 */
async function runNextAFC(list, phase) {
  if (afcIdx >= list.length) return finishAFC(phase);
  const item = list[afcIdx];
  // ... (UI 로직)
  btn.onclick = async () => { 
    const isCorrect = (c.itemId === item.itemId);
    if(isCorrect) afcScore++; else afcWrongItems.push(item);
    
    // 각 4AFC 시행 데이터 저장
    appendRow({
      event: "afc_trial", pid: session.pid, sessionId: session.sessionId,
      phase: phase, trialIdx: afcIdx + 1, targetId: item.itemId,
      response: c.word, correct: isCorrect
    });
    
    afcIdx++; runNextAFC(list, phase); 
  };
}

/* 3. 본 실험 데이터 저장 (Onset 및 Timeout 포함) */
async function runPriming() {
  for (let i = 0; i < PRIMING_TRIALS.length; i++) {
    const trial = PRIMING_TRIALS[i];
    // ... (자극 제시 로직)

    const recData = await record(3000);
    
    // 무응답 여부 체크 및 카운트
    const isTimeout = (recData.onset === null);
    if (isTimeout) timeoutCount++;

    // 시행 데이터 저장
    appendRow({
      event: "priming_trial", pid: session.pid, sessionId: session.sessionId,
      listNum: listNumUsed, primeModeGroup: assignedGroup, trialIdx: i + 1,
      pair_id: trial.pair_id, primeWord: trial.primeWord, targetWord: trial.targetWord,
      onset_ms: recData.onset, timeout: isTimeout
    });

    if (timeoutCount >= FAIL_LIMIT) { 
      alert("무응답 누적으로 종료합니다."); 
      location.reload(); return; 
    }

    // 오디오 파일 업로드
    uploadAudioBlob(recData.blob, { 
      pid: session.pid, sessionId: session.sessionId, folderId: session.folderId, 
      filename: `${session.pid}_T${i}_target.webm`, trialId: trial.pair_id, phase: "priming" 
    }).catch(() => uploadFailCount++);
    
    // ... (ITI 로직)
  }
}
// ... (이하 생략)
</script>
